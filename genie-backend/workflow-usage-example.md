# WORKFLOW Agent ä½¿ç”¨ç¤ºä¾‹

æœ¬æ–‡æ¡£å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨æ–°å®ç°çš„ WORKFLOW Agent æ¥æ‰§è¡Œå¤æ‚çš„å¤šæ­¥éª¤ä»»åŠ¡ã€‚

## 1. åŸºæœ¬ä½¿ç”¨

### 1.1 é€šè¿‡APIè¯·æ±‚ä½¿ç”¨WORKFLOW Agentï¼ˆè‡ªåŠ¨åŒ¹é…æ¨¡æ¿ï¼‰

```json
{
  "requestId": "req-12345",
  "erp": "user123",
  "query": "è¯·å¸®æˆ‘åˆ†ææœ€è¿‘çš„é”€å”®æ•°æ®è¶‹åŠ¿",
  "agentType": 2,
  "isStream": true,
  "executionMode": "batch"
}
```

### 1.2 ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„å·¥ä½œæµæ¨¡æ¿

```json
{
  "requestId": "req-12345",
  "erp": "user123", 
  "query": "åˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®",
  "agentType": 2,
  "isStream": true,
  "workflowTemplate": "data-analysis"
}
```

### 1.3 ä½¿ç”¨æ¨¡æ¿å¹¶è‡ªå®šä¹‰å˜é‡

```json
{
  "requestId": "req-12345",
  "erp": "user123", 
  "query": "åˆ†æäº§å“é”€å”®æ•°æ®",
  "agentType": 2,
  "isStream": true,
  "workflowTemplate": "data-analysis",
  "workflowVariables": "{\"analysis_scope\":\"æ·±åº¦åˆ†æ\",\"report_format\":\"å›¾è¡¨æŠ¥å‘Š\"}"
}
```

### 1.4 ä½¿ç”¨å†…è”JSONå®šä¹‰å·¥ä½œæµ

```json
{
  "requestId": "req-12345",
  "erp": "user123", 
  "query": "åˆ†æç”¨æˆ·è¡Œä¸ºæ•°æ®",
  "agentType": 2,
  "isStream": true,
  "workflowDefinition": "{\"id\":\"custom-analysis\",\"name\":\"è‡ªå®šä¹‰åˆ†æå·¥ä½œæµ\",\"steps\":[{\"id\":\"step1\",\"name\":\"æ•°æ®æ”¶é›†\",\"type\":\"llm_call\",\"prompt\":\"æ”¶é›†ç”¨æˆ·è¡Œä¸ºæ•°æ®\"},{\"id\":\"step2\",\"name\":\"æ•°æ®åˆ†æ\",\"type\":\"llm_call\",\"prompt\":\"åˆ†ææ”¶é›†åˆ°çš„æ•°æ®\"}]}"
}
```

## 2. å·¥ä½œæµæ¨¡æ¿ä½¿ç”¨

### 2.1 æ•°æ®åˆ†ææ¨¡æ¿
é€‚ç”¨äºéœ€è¦å¯¹æ•°æ®è¿›è¡Œæ”¶é›†ã€å¤„ç†ã€åˆ†æå’ŒæŠ¥å‘Šçš„åœºæ™¯ã€‚

**è§¦å‘ç¤ºä¾‹ï¼š**
- "è¯·åˆ†ææˆ‘ä»¬çš„é”€å”®æ•°æ®"
- "å¸®æˆ‘åšä¸€ä¸ªç”¨æˆ·è¡Œä¸ºåˆ†æ"
- "åˆ†æäº§å“æ€§èƒ½æ•°æ®"

**æ‰§è¡Œæ­¥éª¤ï¼š**
1. æ•°æ®æ”¶é›† - ç¡®å®šæ•°æ®æ¥æºå’Œç±»å‹
2. æ•°æ®å¤„ç† - æ¸…æ´—å’Œé¢„å¤„ç†æ•°æ®
3. æ•°æ®åˆ†æ - å‘ç°è¶‹åŠ¿å’Œæ¨¡å¼
4. ç»“æœæŠ¥å‘Š - ç”Ÿæˆå®Œæ•´åˆ†ææŠ¥å‘Š

### 2.2 ç ”ç©¶æ¨¡æ¿
é€‚ç”¨äºéœ€è¦æ·±å…¥ç ”ç©¶æŸä¸ªä¸»é¢˜çš„åœºæ™¯ã€‚

**è§¦å‘ç¤ºä¾‹ï¼š**
- "ç ”ç©¶äººå·¥æ™ºèƒ½åœ¨é‡‘èè¡Œä¸šçš„åº”ç”¨"
- "è°ƒç ”ç«äº‰å¯¹æ‰‹çš„äº§å“ç­–ç•¥"
- "æŸ¥æ‰¾æœ€æ–°çš„æŠ€æœ¯è¶‹åŠ¿"

**æ‰§è¡Œæ­¥éª¤ï¼š**
1. åˆ¶å®šç ”ç©¶è®¡åˆ’ - ç¡®å®šç ”ç©¶èŒƒå›´å’Œæ–¹æ³•
2. ä¿¡æ¯æœç´¢ - ä½¿ç”¨æ·±åº¦æœç´¢å·¥å…·
3. ä¿¡æ¯åˆ†æ - åˆ†ææœç´¢ç»“æœ
4. ç ”ç©¶æŠ¥å‘Š - ç”Ÿæˆç ”ç©¶æŠ¥å‘Š

### 2.3 é—®é¢˜è§£å†³æ¨¡æ¿
é€‚ç”¨äºéœ€è¦ç³»ç»Ÿæ€§è§£å†³å¤æ‚é—®é¢˜çš„åœºæ™¯ã€‚

**è§¦å‘ç¤ºä¾‹ï¼š**
- "å¦‚ä½•æé«˜å®¢æˆ·æ»¡æ„åº¦"
- "è§£å†³äº§å“è´¨é‡é—®é¢˜"
- "ä¼˜åŒ–ä¸šåŠ¡æµç¨‹"

**æ‰§è¡Œæ­¥éª¤ï¼š**
1. é—®é¢˜åˆ†æ - æ·±å…¥åˆ†æé—®é¢˜æœ¬è´¨
2. æ–¹æ¡ˆè®¾è®¡ - è®¾è®¡è§£å†³æ–¹æ¡ˆ
3. æ–¹æ¡ˆè¯„ä¼° - è¯„ä¼°å¯è¡Œæ€§å’Œé£é™©
4. å®æ–½å»ºè®® - æä¾›å…·ä½“å®æ–½è®¡åˆ’

## 3. è‡ªå®šä¹‰å·¥ä½œæµ

### 3.1 å®Œæ•´çš„å·¥ä½œæµå®šä¹‰ç¤ºä¾‹

```json
{
  "id": "custom-workflow-001",
  "name": "äº§å“åˆ†æå·¥ä½œæµ",
  "description": "åˆ†æäº§å“å¸‚åœºè¡¨ç°å’Œç”¨æˆ·åé¦ˆ",
  "maxSteps": 10,
  "timeoutSeconds": 3600,
  "variables": {
    "product_name": "æ™ºèƒ½åŠ©æ‰‹",
    "analysis_period": "æœ€è¿‘3ä¸ªæœˆ"
  },
  "steps": [
    {
      "id": "market-research",
      "name": "å¸‚åœºè°ƒç ”",
      "type": "llm_call",
      "prompt": "åˆ†æ${product_name}åœ¨${analysis_period}çš„å¸‚åœºè¡¨ç°",
      "systemPrompt": "ä½ æ˜¯ä¸€ä¸ªå¸‚åœºåˆ†æä¸“å®¶"
    },
    {
      "id": "user-feedback-analysis", 
      "name": "ç”¨æˆ·åé¦ˆåˆ†æ",
      "type": "tool_call",
      "toolName": "deep_search",
      "toolArgs": {
        "query": "${product_name} ç”¨æˆ·è¯„ä»· åé¦ˆ",
        "time_range": "${analysis_period}"
      }
    },
    {
      "id": "competitive-analysis",
      "name": "ç«å“åˆ†æ", 
      "type": "llm_call",
      "prompt": "åŸºäºå¸‚åœºç ”ç©¶${step.market-research}å’Œç”¨æˆ·åé¦ˆ${step.user-feedback-analysis}ï¼Œåˆ†æç«äº‰æ€åŠ¿",
      "dependencies": ["market-research", "user-feedback-analysis"]
    },
    {
      "id": "recommendations",
      "name": "æ”¹è¿›å»ºè®®",
      "type": "llm_call",
      "prompt": "åŸºäºåˆ†æç»“æœï¼Œæå‡ºäº§å“æ”¹è¿›å»ºè®®",
      "dependencies": ["competitive-analysis"]
    }
  ]
}
```

### 3.2 å¹¶è¡Œæ‰§è¡Œæ­¥éª¤ç¤ºä¾‹

```json
{
  "id": "parallel-analysis",
  "name": "å¹¶è¡Œåˆ†æå·¥ä½œæµ",
  "steps": [
    {
      "id": "parallel-tasks",
      "name": "å¹¶è¡Œä»»åŠ¡æ‰§è¡Œ",
      "type": "parallel",
      "maxConcurrency": 3,
      "waitForAll": true,
      "subSteps": [
        {
          "id": "task1",
          "type": "llm_call", 
          "prompt": "åˆ†ææŠ€æœ¯æŒ‡æ ‡"
        },
        {
          "id": "task2",
          "type": "tool_call",
          "toolName": "deep_search",
          "toolArgs": {"query": "è¡Œä¸šæ•°æ®"}
        },
        {
          "id": "task3",
          "type": "llm_call",
          "prompt": "è¯„ä¼°ç”¨æˆ·ä½“éªŒ"
        }
      ]
    }
  ]
}
```

### 3.3 å¦‚ä½•å®šä¹‰ä¸€ä¸ªå·¥å…·æµï¼ˆTool Flowï¼‰

å·¥å…·æµæ˜¯ä»¥ä¸€ä¸ªæˆ–å¤šä¸ª `tool_call` æ­¥éª¤ä¸ºæ ¸å¿ƒï¼Œé€šè¿‡ä¾èµ–ä¸å˜é‡æŠŠå·¥å…·è¾“å…¥è¾“å‡ºä¸²è”èµ·æ¥çš„å·¥ä½œæµã€‚åº•å±‚ç”± `ToolCallStep` æ‰§è¡Œï¼Œå­—æ®µå¯¹æ¥å¦‚ä¸‹ï¼š
- `type`: å›ºå®šä¸º `"tool_call"`ï¼Œå®é™…æ˜ å°„ä¸º `StepType.TOOL_CALL`
- `toolName`: å·¥å…·åç§°ï¼ˆå¿…å¡«ï¼‰ï¼Œå°†ä¼ ç»™ `ToolCollection.execute(toolName, toolArgs)`
- `toolArgs`: å·¥å…·å…¥å‚ï¼ˆå¯¹è±¡/å­—å…¸ï¼‰ï¼Œæ”¯æŒå˜é‡æ’å€¼
- å¯é€‰é€šç”¨æ§åˆ¶ï¼š`dependencies`ã€`condition`ã€`retryPolicy`ã€`timeoutSeconds`ã€`skippable`

#### æœ€å°å¯è¿è¡Œç¤ºä¾‹
```json
{
  "id": "tool-flow-min",
  "name": "æœ€å°å·¥å…·æµ",
  "steps": [
    {
      "id": "call-deepsearch",
      "type": "tool_call",
      "toolName": "deep_search",
      "toolArgs": {"query": "è¡Œä¸šè¶‹åŠ¿"}
    }
  ]
}
```

#### è¿›é˜¶ç¤ºä¾‹ï¼šä¸²è”å¤šä¸ªå·¥å…·å¹¶å¤ç”¨ä¸Šä¸€æ­¥ç»“æœ
```json
{
  "id": "tool-flow-advanced",
  "name": "å·¥å…·æµ-ä¸²è”",
  "variables": {"topic": "AIGC"},
  "steps": [
    {
      "id": "search",
      "name": "æœç´¢",
      "type": "tool_call",
      "toolName": "deep_search",
      "toolArgs": {"query": "${topic} è¡Œä¸šæŠ¥å‘Š 2024"}
    },
    {
      "id": "summarize",
      "name": "æ‘˜è¦æ•´ç†",
      "type": "tool_call",
      "dependencies": ["search"],
      "toolName": "report",
      "toolArgs": {"content": "${step.search}"}
    }
  ]
}
```

#### å­—æ®µè¯´æ˜ä¸å»ºè®®
- `toolName`ï¼ˆå¿…å¡«ï¼‰: å¯¹åº”åç«¯å·²æ³¨å†Œåˆ° `ToolCollection` çš„å·¥å…·åï¼Œå¦åˆ™ä¼šæ‰§è¡Œå¤±è´¥
- `toolArgs`: æŒ‰å·¥å…·å®šä¹‰ä¼ å…¥ç»“æ„å³å¯ï¼›æ¨èä¸ `variables` é…åˆä½¿ç”¨ï¼Œä¾¿äºå¤ç”¨
- `dependencies`: ä¿è¯é¡ºåº/æ•°æ®ä¾èµ–ï¼Œå¼•ç”¨ä¸Šä¸€æ­¥è¾“å‡ºç”¨ `${step.<id>}`
- `retryPolicy`: ä¾‹å¦‚
  ```json
  {
    "maxRetries": 2,
    "retryDelayMs": 1000,
    "retryType": "FIXED_DELAY"
  }
  ```
- `timeoutSeconds`: è¶…æ—¶ä¸Šé™ï¼ˆç§’ï¼‰ï¼›é»˜è®¤ 300ï¼ˆè§ `WorkflowStep`ï¼‰
- `skippable`: å¯è·³è¿‡éå…³é”®æ­¥éª¤ä»¥æå‡é²æ£’æ€§

#### å¹¶è¡Œå·¥å…·æµ
- ç”¨ `type: "parallel"` + `subSteps` ç»„ç»‡å¤šä¸ª `tool_call` å¹¶è¡Œæ‰§è¡Œ
- å¯è®¾ç½® `maxConcurrency` é™åˆ¶å¹¶å‘æ•°ï¼Œ`waitForAll` æ§åˆ¶æ˜¯å¦ç­‰å¾…å…¨éƒ¨å®Œæˆå†ç»§ç»­

#### å¸¸è§é”™è¯¯
- æ¼å¡« `toolName` â†’ å°†è§¦å‘æ ¡éªŒé”™è¯¯æˆ–è¿è¡Œé”™è¯¯
- `toolArgs` ç»“æ„ä¸å·¥å…·ä¸åŒ¹é… â†’ å·¥å…·æŠ›å‡º `IllegalArgumentException/IllegalStateException` æ—¶ä¸ä¼šé‡è¯•
- å¼•ç”¨ `${step.xxx}` æ—¶ `dependencies` æœªå£°æ˜ â†’ å¯èƒ½åœ¨è¿è¡ŒæœŸæ‰¾ä¸åˆ°å‰ç½®ç»“æœ

## 4. å•æ­¥æ‰§è¡Œæ¨¡å¼

é€‚ç”¨äºéœ€è¦é€æ­¥æ§åˆ¶æ‰§è¡Œè¿›åº¦çš„åœºæ™¯ã€‚

```json
{
  "requestId": "req-12345",
  "erp": "user123",
  "query": "é€æ­¥åˆ†æé”€å”®æ•°æ®",
  "agentType": 2,
  "executionMode": "step",
  "isStream": true
}
```

åœ¨å•æ­¥æ‰§è¡Œæ¨¡å¼ä¸‹ï¼Œç³»ç»Ÿä¼šé€ä¸ªæ‰§è¡Œå·¥ä½œæµæ­¥éª¤ï¼Œç”¨æˆ·å¯ä»¥çœ‹åˆ°æ¯ä¸€æ­¥çš„è¯¦ç»†æ‰§è¡Œè¿‡ç¨‹ã€‚

## 5. å·¥ä½œæµå·¥å…·ä½¿ç”¨

### 5.1 åˆ›å»ºå·¥ä½œæµ

```json
{
  "command": "create",
  "template_name": "data_analysis"
}
```

### 5.2 æŸ¥çœ‹å·¥ä½œæµçŠ¶æ€

```json
{
  "command": "status",
  "workflow_id": "workflow-12345"
}
```

### 5.3 æ§åˆ¶å·¥ä½œæµæ‰§è¡Œ

```json
// æš‚åœ
{
  "command": "pause",
  "workflow_id": "workflow-12345"
}

// æ¢å¤
{
  "command": "resume", 
  "workflow_id": "workflow-12345"
}

// å–æ¶ˆ
{
  "command": "cancel",
  "workflow_id": "workflow-12345"
}
```

### 5.4 åˆ—å‡ºå¯ç”¨æ¨¡æ¿

```json
{
  "command": "list_templates"
}
```

## 6. å“åº”æ ¼å¼

### 6.1 å·¥ä½œæµå¼€å§‹å“åº”

```json
{
  "status": "success",
  "finished": false,
  "responseType": "text",
  "packageType": "workflow_start",
  "response": "ğŸš€ å·¥ä½œæµå·²å¼€å§‹æ‰§è¡Œ\n\nğŸ“‹ å·¥ä½œæµåç§°: æ•°æ®åˆ†æå·¥ä½œæµ\nğŸ“ æè¿°: å®Œæ•´çš„æ•°æ®åˆ†ææµç¨‹\nğŸ”¢ æ€»æ­¥éª¤æ•°: 4\nâ±ï¸ é¢„ä¼°æ—¶é—´: çº¦2-3åˆ†é’Ÿ\n\næ­£åœ¨æ‰§è¡Œä¸­ï¼Œè¯·ç¨å€™...",
  "resultMap": {
    "name": "æ•°æ®åˆ†æå·¥ä½œæµ",
    "description": "å®Œæ•´çš„æ•°æ®åˆ†ææµç¨‹", 
    "totalSteps": 4,
    "estimatedTime": "çº¦2-3åˆ†é’Ÿ"
  }
}
```

### 6.2 æ­¥éª¤å®Œæˆå“åº”

```json
{
  "status": "success",
  "finished": false,
  "responseType": "text", 
  "packageType": "workflow_step",
  "response": "âœ… æ­¥éª¤å®Œæˆ: æ•°æ®æ”¶é›†\n\nğŸ“‹ æ‰§è¡Œç»“æœ:\nå·²ç¡®å®šéœ€è¦æ”¶é›†çš„æ•°æ®ç±»å‹åŒ…æ‹¬é”€å”®æ•°æ®ã€ç”¨æˆ·è¡Œä¸ºæ•°æ®å’Œå¸‚åœºè¶‹åŠ¿æ•°æ®...\n\n---"
}
```

### 6.3 å·¥ä½œæµå®Œæˆå“åº”

```json
{
  "status": "success",
  "finished": true,
  "responseType": "text",
  "packageType": "workflow_complete", 
  "response": "ğŸ‰ å·¥ä½œæµæ‰§è¡ŒæˆåŠŸ!\n\nğŸ“Š æ‰§è¡Œç»Ÿè®¡:\nâ€¢ æ€»æ­¥éª¤æ•°: 4\nâ€¢ æ‰§è¡Œæ—¶é—´: 125.30 ç§’\n\nğŸ“‹ æœ€ç»ˆç»“æœ:\næ•°æ®åˆ†æå·²å®Œæˆï¼Œå‘ç°ä»¥ä¸‹å…³é”®æ´å¯Ÿ...",
  "resultMap": {
    "success": true,
    "totalSteps": 4,
    "executionTime": 125300
  }
}
```

## 7. æœ€ä½³å®è·µ

### 7.1 å·¥ä½œæµè®¾è®¡åŸåˆ™
1. **æ¨¡å—åŒ–è®¾è®¡** - å°†å¤æ‚ä»»åŠ¡åˆ†è§£ä¸ºç‹¬ç«‹çš„æ­¥éª¤
2. **åˆç†ä¾èµ–** - æ˜ç¡®æ­¥éª¤é—´çš„ä¾èµ–å…³ç³»
3. **é”™è¯¯å¤„ç†** - ä¸ºå…³é”®æ­¥éª¤è®¾ç½®é‡è¯•ç­–ç•¥
4. **å‚æ•°åŒ–** - ä½¿ç”¨å˜é‡ä½¿å·¥ä½œæµæ›´çµæ´»

### 7.2 æ€§èƒ½ä¼˜åŒ–
1. **å¹¶è¡Œæ‰§è¡Œ** - å¯¹ç‹¬ç«‹ä»»åŠ¡ä½¿ç”¨å¹¶è¡Œæ­¥éª¤
2. **è¶…æ—¶æ§åˆ¶** - åˆç†è®¾ç½®æ­¥éª¤å’Œå·¥ä½œæµè¶…æ—¶æ—¶é—´
3. **èµ„æºç®¡ç†** - æ§åˆ¶å¹¶å‘æ•°é¿å…èµ„æºç«äº‰

### 7.3 ç›‘æ§å’Œè°ƒè¯•
1. **æ—¥å¿—è®°å½•** - æ¯ä¸ªæ­¥éª¤éƒ½æœ‰è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—
2. **è¿›åº¦è·Ÿè¸ª** - å®æ—¶ç›‘æ§å·¥ä½œæµæ‰§è¡Œè¿›åº¦
3. **é”™è¯¯è¯Šæ–­** - æä¾›è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯å’Œå»ºè®®

## 8. å¸¸è§é—®é¢˜

### 8.1 å¦‚ä½•å¤„ç†æ­¥éª¤å¤±è´¥ï¼Ÿ
ç³»ç»Ÿä¼šæ ¹æ®æ­¥éª¤çš„ `skippable` å±æ€§å†³å®šæ˜¯å¦ç»§ç»­æ‰§è¡Œã€‚å…³é”®æ­¥éª¤å¤±è´¥ä¼šç»ˆæ­¢å·¥ä½œæµï¼Œå¯è·³è¿‡çš„æ­¥éª¤å¤±è´¥ä¼šç»§ç»­æ‰§è¡Œã€‚

### 8.2 å¦‚ä½•ä¼ é€’æ­¥éª¤é—´çš„æ•°æ®ï¼Ÿ
ä½¿ç”¨å˜é‡è¯­æ³• `${step.stepId}` æ¥å¼•ç”¨å‰é¢æ­¥éª¤çš„ç»“æœã€‚

### 8.3 å¦‚ä½•å®ç°æ¡ä»¶æ‰§è¡Œï¼Ÿ
ä½¿ç”¨æ­¥éª¤æ¡ä»¶ `StepCondition` æ¥æ§åˆ¶æ­¥éª¤æ˜¯å¦æ‰§è¡Œã€‚

### 8.4 å·¥ä½œæµæ‰§è¡Œæ—¶é—´è¿‡é•¿æ€ä¹ˆåŠï¼Ÿ
å¯ä»¥è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´ï¼Œæˆ–è€…ä½¿ç”¨å•æ­¥æ‰§è¡Œæ¨¡å¼è¿›è¡Œè°ƒè¯•ã€‚

## 9. æ‰©å±•å¼€å‘

å¦‚éœ€æ·»åŠ æ–°çš„æ­¥éª¤ç±»å‹æˆ–å·¥ä½œæµåŠŸèƒ½ï¼Œå¯ä»¥ï¼š

1. **æ‰©å±•æ­¥éª¤ç±»å‹** - ç»§æ‰¿ `WorkflowStep` åŸºç±»
2. **æ·»åŠ æ–°å·¥å…·** - åœ¨ `WorkflowTool` ä¸­æ·»åŠ æ–°å‘½ä»¤
3. **è‡ªå®šä¹‰å“åº”å¤„ç†** - åœ¨ `WorkflowAgentResponseHandler` ä¸­å¤„ç†æ–°çš„å“åº”ç±»å‹
4. **åˆ›å»ºæ–°æ¨¡æ¿** - åœ¨ç³»ç»Ÿä¸­æ³¨å†Œæ–°çš„å·¥ä½œæµæ¨¡æ¿

é€šè¿‡è¿™ç§æ¨¡å—åŒ–çš„è®¾è®¡ï¼ŒWORKFLOW Agent å…·æœ‰è‰¯å¥½çš„æ‰©å±•æ€§ï¼Œå¯ä»¥é€‚åº”å„ç§å¤æ‚çš„ä¸šåŠ¡åœºæ™¯ã€‚

## 10. é…ç½®æ–‡ä»¶å®šä¹‰å·¥ä½œæµ

### 10.1 é…ç½®æ–‡ä»¶ä½ç½®

å·¥ä½œæµæ¨¡æ¿å®šä¹‰åœ¨ `src/main/resources/workflows.yml` æ–‡ä»¶ä¸­ã€‚

### 10.2 é…ç½®æ–‡ä»¶ç»“æ„

```yaml
# å·¥ä½œæµé…ç½®æ–‡ä»¶
workflows:
  # æ¨¡æ¿åç§°
  template-name:
    id: "template-id"
    name: "æ¨¡æ¿æ˜¾ç¤ºåç§°"
    description: "æ¨¡æ¿æè¿°"
    maxSteps: 10
    timeoutSeconds: 3600
    variables:
      var1: "é»˜è®¤å€¼1"
      var2: "é»˜è®¤å€¼2"
    steps:
      - id: "step-id"
        name: "æ­¥éª¤åç§°"
        type: "æ­¥éª¤ç±»å‹"
        # å…¶ä»–æ­¥éª¤é…ç½®...

# å…¨å±€è®¾ç½®
settings:
  defaultConfig:
    maxSteps: 50
    timeoutSeconds: 1800
  enableCache: true
  defaultExecutionMode: "batch"
```

### 10.3 é¢„å®šä¹‰æ¨¡æ¿

ç³»ç»Ÿæä¾›ä»¥ä¸‹é¢„å®šä¹‰æ¨¡æ¿ï¼š

#### 10.3.1 æ•°æ®åˆ†ææ¨¡æ¿ (`data-analysis`)
- **ç”¨é€”**: å®Œæ•´çš„æ•°æ®åˆ†ææµç¨‹
- **æ­¥éª¤**: æ•°æ®æ”¶é›† â†’ æ•°æ®æœç´¢ â†’ æ•°æ®å¤„ç† â†’ æ•°æ®åˆ†æ â†’ ç»“æœæŠ¥å‘Š
- **å˜é‡**: `analysis_scope`ã€`report_format`

#### 10.3.2 ç ”ç©¶æ¨¡æ¿ (`research`)
- **ç”¨é€”**: æ·±åº¦ç ”ç©¶æµç¨‹
- **æ­¥éª¤**: ç ”ç©¶è®¡åˆ’ â†’ ä¿¡æ¯æœç´¢ â†’ ä¿¡æ¯åˆ†æ â†’ ç ”ç©¶æŠ¥å‘Š
- **å˜é‡**: `research_depth`ã€`search_scope`

#### 10.3.3 å¹¶è¡Œåˆ†ææ¨¡æ¿ (`parallel-analysis`)
- **ç”¨é€”**: å¤šç»´åº¦å¹¶è¡Œåˆ†æ
- **æ­¥éª¤**: å¹¶è¡Œä»»åŠ¡ï¼ˆæŠ€æœ¯åˆ†æ+å¸‚åœºæœç´¢+ç”¨æˆ·ä½“éªŒï¼‰ â†’ ç»¼åˆåˆ†æ

#### 10.3.4 é—®é¢˜è§£å†³æ¨¡æ¿ (`problem-solving`)
- **ç”¨é€”**: ç³»ç»Ÿæ€§é—®é¢˜è§£å†³
- **æ­¥éª¤**: é—®é¢˜åˆ†æ â†’ èƒŒæ™¯ç ”ç©¶ â†’ æ–¹æ¡ˆè®¾è®¡ â†’ æ–¹æ¡ˆè¯„ä¼° â†’ å®æ–½å»ºè®®
- **å˜é‡**: `solution_type`ã€`evaluation_criteria`

#### 10.3.5 ç®€å•å·¥å…·æµæ¨¡æ¿ (`simple-tool-flow`)
- **ç”¨é€”**: æ¼”ç¤ºå·¥å…·è°ƒç”¨æµç¨‹
- **æ­¥éª¤**: æœç´¢ä¿¡æ¯ â†’ åˆ†æç»“æœ â†’ ç”ŸæˆæŠ¥å‘Š
- **å˜é‡**: `search_query`

### 10.4 ä½¿ç”¨é…ç½®æ–‡ä»¶æ¨¡æ¿

#### 10.4.1 ç›´æ¥æŒ‡å®šæ¨¡æ¿åç§°

```json
{
  "requestId": "req-12345",
  "erp": "user123",
  "query": "åˆ†æå¸‚åœºè¶‹åŠ¿",
  "agentType": 2,
  "workflowTemplate": "data-analysis"
}
```

#### 10.4.2 ä½¿ç”¨æ¨¡æ¿å¹¶è¦†ç›–å˜é‡

```json
{
  "requestId": "req-12345",
  "erp": "user123",
  "query": "ç ”ç©¶AIå‘å±•è¶‹åŠ¿",
  "agentType": 2,
  "workflowTemplate": "research",
  "workflowVariables": "{\"research_depth\":\"æ·±åº¦ç ”ç©¶\",\"search_scope\":\"å…¨çƒèŒƒå›´\"}"
}
```

### 10.5 è‡ªå®šä¹‰é…ç½®æ–‡ä»¶æ¨¡æ¿

#### 10.5.1 æ·»åŠ æ–°æ¨¡æ¿

åœ¨ `workflows.yml` ä¸­æ·»åŠ æ–°çš„æ¨¡æ¿å®šä¹‰ï¼š

```yaml
workflows:
  my-custom-template:
    id: "my-custom-template"
    name: "æˆ‘çš„è‡ªå®šä¹‰æ¨¡æ¿"
    description: "è‡ªå®šä¹‰å·¥ä½œæµæ¨¡æ¿"
    maxSteps: 5
    timeoutSeconds: 1200
    variables:
      custom_var: "é»˜è®¤å€¼"
    steps:
      - id: "custom-step-1"
        name: "è‡ªå®šä¹‰æ­¥éª¤1"
        type: "llm_call"
        prompt: "æ‰§è¡Œè‡ªå®šä¹‰ä»»åŠ¡ï¼š${query}"
        systemPrompt: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šåŠ©æ‰‹"
      - id: "custom-step-2"
        name: "è‡ªå®šä¹‰æ­¥éª¤2"
        type: "tool_call"
        toolName: "deep_search"
        toolArgs:
          query: "${custom_var}"
        dependencies: ["custom-step-1"]
```

#### 10.5.2 æ­¥éª¤ç±»å‹æ”¯æŒ

- `llm_call`: LLMè°ƒç”¨æ­¥éª¤
  - `prompt`: æç¤ºè¯ï¼ˆæ”¯æŒå˜é‡æ’å€¼ï¼‰
  - `systemPrompt`: ç³»ç»Ÿæç¤ºè¯
- `tool_call`: å·¥å…·è°ƒç”¨æ­¥éª¤
  - `toolName`: å·¥å…·åç§°
  - `toolArgs`: å·¥å…·å‚æ•°ï¼ˆæ”¯æŒå˜é‡æ’å€¼ï¼‰
- `sequential`: é¡ºåºæ‰§è¡Œæ­¥éª¤
  - `subSteps`: å­æ­¥éª¤åˆ—è¡¨
- `parallel`: å¹¶è¡Œæ‰§è¡Œæ­¥éª¤
  - `subSteps`: å­æ­¥éª¤åˆ—è¡¨
  - `maxConcurrency`: æœ€å¤§å¹¶å‘æ•°
  - `waitForAll`: æ˜¯å¦ç­‰å¾…æ‰€æœ‰å­æ­¥éª¤å®Œæˆ

#### 10.5.3 æ­¥éª¤é…ç½®é€‰é¡¹

æ¯ä¸ªæ­¥éª¤éƒ½æ”¯æŒä»¥ä¸‹é€šç”¨é…ç½®ï¼š

```yaml
- id: "step-id"
  name: "æ­¥éª¤åç§°"
  description: "æ­¥éª¤æè¿°"
  type: "æ­¥éª¤ç±»å‹"
  dependencies: ["å‰ç½®æ­¥éª¤ID"]
  condition: "æ‰§è¡Œæ¡ä»¶è¡¨è¾¾å¼"
  timeoutSeconds: 300
  skippable: false
  retryPolicy:
    maxRetries: 2
    retryDelayMs: 1000
    retryType: "FIXED_DELAY"
    backoffMultiplier: 2.0
    maxRetryDelayMs: 10000
```

### 10.6 å·¥ä½œæµç®¡ç†å·¥å…·

å¯ä»¥ä½¿ç”¨ `workflow` å·¥å…·æ¥ç®¡ç†é…ç½®æ–‡ä»¶ä¸­çš„æ¨¡æ¿ï¼š

#### 10.6.1 åˆ—å‡ºæ‰€æœ‰æ¨¡æ¿

```json
{
  "command": "list_templates"
}
```

#### 10.6.2 è·å–æ¨¡æ¿ä¿¡æ¯

```json
{
  "command": "template_info",
  "template_name": "data-analysis"
}
```

#### 10.6.3 è·å–å®Œæ•´æ¨¡æ¿å®šä¹‰

```json
{
  "command": "get_template",
  "template_name": "research"
}
```

#### 10.6.4 é‡æ–°åŠ è½½é…ç½®

```json
{
  "command": "reload"
}
```

### 10.7 å·¥ä½œæµé€‰æ‹©ä¼˜å…ˆçº§

ç³»ç»ŸæŒ‰ä»¥ä¸‹ä¼˜å…ˆçº§é€‰æ‹©å·¥ä½œæµï¼š

1. **æŒ‡å®šæ¨¡æ¿åç§°** (`workflowTemplate`)
2. **å†…è”JSONå®šä¹‰** (`workflowDefinition`)
3. **æ™ºèƒ½æ¨¡æ¿åŒ¹é…** (æ ¹æ®æŸ¥è¯¢å†…å®¹è‡ªåŠ¨åŒ¹é…)
4. **é»˜è®¤æ™ºèƒ½ç”Ÿæˆ** (åŠ¨æ€åˆ›å»ºå·¥ä½œæµ)

### 10.8 å˜é‡æ’å€¼

é…ç½®æ–‡ä»¶ä¸­æ”¯æŒä»¥ä¸‹å˜é‡æ’å€¼ï¼š

- `${query}`: ç”¨æˆ·æŸ¥è¯¢å†…å®¹
- `${requestId}`: è¯·æ±‚ID
- `${erp}`: ç”¨æˆ·ERP
- `${variable_name}`: è‡ªå®šä¹‰å˜é‡
- `${step.step_id}`: å¼•ç”¨å‰ç½®æ­¥éª¤ç»“æœ

### 10.9 é…ç½®æ–‡ä»¶ä¼˜åŠ¿

ä½¿ç”¨é…ç½®æ–‡ä»¶å®šä¹‰å·¥ä½œæµçš„ä¼˜åŠ¿ï¼š

1. **å¯ç»´æŠ¤æ€§**: é›†ä¸­ç®¡ç†ï¼Œæ˜“äºä¿®æ”¹å’Œç‰ˆæœ¬æ§åˆ¶
2. **å¯é‡ç”¨æ€§**: ä¸€æ¬¡å®šä¹‰ï¼Œå¤šæ¬¡ä½¿ç”¨
3. **æ ‡å‡†åŒ–**: ç»Ÿä¸€çš„å·¥ä½œæµè§„èŒƒå’Œæœ€ä½³å®è·µ
4. **çµæ´»æ€§**: æ”¯æŒå˜é‡æ’å€¼å’ŒåŠ¨æ€é…ç½®
5. **æ€§èƒ½**: é¢„ç¼–è¯‘æ¨¡æ¿ï¼Œæ‰§è¡Œæ•ˆç‡é«˜